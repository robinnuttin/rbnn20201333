rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ====================================================================
    // Helper Functions
    // ====================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth.uid in ['admin_uid_1', 'admin_uid_2'];
    }

    // Rate limiting: Max 100 reads per minute per user
    function withinReadLimit() {
      return request.auth.token.iam_roles.size() < 100;
    }

    // ====================================================================
    // Leads Collection
    // ====================================================================

    match /leads/{leadId} {
      // Read: Authenticated users can read
      allow read: if isAuthenticated();

      // Write: Only authenticated users and only their own leads
      allow create, update: if isAuthenticated() &&
        request.resource.data.companyName != null &&
        request.resource.data.scrapedAt != null &&
        request.resource.data.size() < 50; // Prevent large documents

      // Delete: Only admins
      allow delete: if isAdmin();

      // Subcollection: interactions (if any)
      match /interactions/{interactionId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated();
        allow delete: if isAdmin();
      }
    }

    // ====================================================================
    // Email Accounts Collection
    // ====================================================================

    match /email_accounts/{accountId} {
      // Read: Only authenticated users
      allow read: if isAuthenticated();

      // Write: Only authenticated users
      allow create, update: if isAuthenticated() &&
        request.resource.data.email != null &&
        request.resource.data.provider in ['smtp', 'instantly'];

      // Delete: Only admins
      allow delete: if isAdmin();
    }

    // ====================================================================
    // Email Campaigns Collection
    // ====================================================================

    match /email_campaigns/{campaignId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() &&
        request.resource.data.name != null &&
        request.resource.data.mode in ['instantly', 'smtp'];
      allow delete: if isAdmin();
    }

    // ====================================================================
    // Email Inbox Collection (Read-Heavy, Cost Control)
    // ====================================================================

    match /email_inbox/{messageId} {
      // Read: Authenticated users can read, but only recent messages
      // (prevents full collection reads = huge cost)
      allow read: if isAuthenticated() &&
        request.query.limit <= 100 &&
        resource.data.timestamp > now - duration.value(30, 'd');

      // Write: Only via Cloud Functions
      allow create, update: if false; // Disabled for client
      allow delete: if isAdmin();
    }

    // ====================================================================
    // SMS Queue Collection
    // ====================================================================

    match /sms_queue/{queueId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
        request.resource.data.status in ['pending', 'sent', 'delivered', 'failed'];
      allow delete: if isAdmin();
    }

    // ====================================================================
    // SMS Conversations Collection
    // ====================================================================

    match /sms_conversations/{conversationId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // ====================================================================
    // Campaigns Collection
    // ====================================================================

    match /campaigns/{campaignId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() &&
        request.resource.data.type in ['email', 'sms', 'call'];
      allow delete: if isAdmin();
    }

    // ====================================================================
    // Scraper Jobs Collection
    // ====================================================================

    match /scraper_jobs/{jobId} {
      // Read: All authenticated users
      allow read: if isAuthenticated();

      // Create: Only authenticated users
      allow create: if isAuthenticated() &&
        request.resource.data.sector != null &&
        request.resource.data.location != null;

      // Update: Cloud Functions only (security via service account)
      allow update: if false; // Disabled for client

      // Delete: Admins only
      allow delete: if isAdmin();
    }

    // ====================================================================
    // Statistics Collection (Internal Use)
    // ====================================================================

    match /_stats/{document=**} {
      // Read: Admins only (cost control)
      allow read: if isAdmin();

      // Write: Cloud Functions only
      allow write: if false;
    }

    // ====================================================================
    // Default: Deny All
    // ====================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
